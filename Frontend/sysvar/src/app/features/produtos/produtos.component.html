<div class="prod-page">
  <div class="page-header">
    <h2>Produtos</h2>
    <div class="actions-right">
      <button class="btn btn-light" (click)="setAction('novo')">Novo</button>
      <button class="btn btn-light" (click)="setAction('consultar')">Consultar</button>
      <button class="btn btn-light" [routerLink]="['/home']">Home</button>
    </div>
  </div>

  <!-- mensagens -->
  <div *ngIf="errorMsg" class="alert error">{{ errorMsg }}</div>
  <div *ngIf="fieldErrors.length" class="alert error">
    <div *ngFor="let fe of fieldErrors">
      <strong>{{ fe.field }}:</strong> {{ fe.messages.join('; ') }}
    </div>
  </div>
  <div *ngIf="successMsg" class="alert success">{{ successMsg }}</div>
  <div *ngIf="infoMsg" class="alert info">{{ infoMsg }}</div>

  <div *ngIf="awaitKeyAfterSave" class="alert info">Pressione qualquer tecla para continuar.</div>

  <ng-container *ngIf="!awaitKeyAfterSave">

    <!-- PLACEHOLDER -->
    <section class="card form-placeholder" *ngIf="action === ''">
      <div class="placeholder-inner">
        <p>Para cadastrar um <strong>Produto</strong>, clique em <strong>Novo</strong>.</p>
        <p>Para editar, localize um <strong>Produto</strong> na lista e clique em <strong>Editar</strong>.</p>
      </div>
    </section>

    <!-- NOVO PRODUTO -->
    <section class="card" *ngIf="action === 'novo'">
      <h3>Novo Produto</h3>

      <form (ngSubmit)="salvar()">
        <!-- Linha 1 -->
        <div class="row">
          <div class="col">
            <label for="referencia">Referência (preview)</label>
            <input id="referencia" type="text" [value]="referenciaPreview" readonly />
          </div>

          <div class="col col-grow">
            <label for="descricao">Descrição*</label>
            <input id="descricao" type="text" [(ngModel)]="form.Descricao" name="descricao" />
          </div>

          <div class="col">
            <label for="descReduzida">Descrição reduzida</label>
            <input id="descReduzida" type="text" [(ngModel)]="form.Desc_reduzida" name="Desc_reduzida" />
          </div>

          <div class="col">
            <label for="ncm">Classificação Fiscal (NCM)*</label>
            <select id="ncm" [(ngModel)]="form.classificacao_fiscal" name="classificacao_fiscal">
              <option [ngValue]="''" disabled>Selecione</option>
              <option *ngFor="let n of ncms" [ngValue]="n.ncm">{{ n.ncm }} — {{ n.descricao || '' }}</option>
            </select>
          </div>
        </div>

        <!-- Linha 2 -->
        <div class="row">
          <div class="col">
            <label for="colecao">Coleção (código)*</label>
            <select id="colecao" [(ngModel)]="form.colecao" name="colecao" (change)="onColecaoChange()">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let cc of colecoesCodigos" [ngValue]="cc">{{ cc }}</option>
            </select>
          </div>

          <div class="col">
            <label for="estacao">Estação*</label>
            <select id="estacao" [(ngModel)]="form.estacao" name="estacao" (change)="onEstacaoChange()">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let e of estacoesDaColecao" [ngValue]="e">{{ e }}</option>
            </select>
          </div>

          <div class="col">
            <label for="grupo">Grupo (código)*</label>
            <select id="grupo" [(ngModel)]="form.grupo" name="grupo" (change)="onGrupoChange()">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let g of grupos" [ngValue]="(g.Codigo || '').toString().padStart(2,'0')">
                {{ (g.Codigo || '').toString().padStart(2,'0') }} — {{ g.Descricao }}
              </option>
            </select>
          </div>

          <div class="col">
            <label for="subgrupo">Subgrupo</label>
            <select id="subgrupo" [(ngModel)]="form.subgrupo" name="subgrupo">
              <option [ngValue]="null">—</option>
              <option *ngFor="let s of subgrupos" [ngValue]="s.Idsubgrupo">{{ s.Descricao }}</option>
            </select>
          </div>

          <div class="col">
            <label for="unidade">Unidade*</label>
            <select id="unidade" [(ngModel)]="form.unidade" name="unidade">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let u of unidades" [ngValue]="u.Idunidade">{{ u.Descricao }}</option>
            </select>
          </div>

          <div class="col">
            <label for="grade">Grade*</label>
            <select id="grade" [(ngModel)]="form.grade" name="grade" (change)="onGradeChange()">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let g of grades" [ngValue]="g.Idgrade">{{ g.Descricao }}</option>
            </select>
          </div>

          <div class="col">
            <label for="tabela">Tabela de Preço*</label>
            <select id="tabela" [(ngModel)]="form.tabela_preco" name="tabela_preco">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let t of tabelasPreco" [ngValue]="t.Idtabela">
                {{ t.NomeTabela }}
              </option>
            </select>
          </div>

          <div class="col">
            <label for="preco">Preço de venda*</label>
            <input id="preco" type="number" step="0.01" min="0" [(ngModel)]="form.Preco" name="Preco" />
          </div>
        </div>

        <!-- Linha da IMAGEM -->
        <div class="row row-image">
          <div class="col img-col">
            <label for="produtoFoto">Imagem (nome do arquivo)</label>
            <input
              id="produtoFoto"
              type="text"
              [(ngModel)]="form.produto_foto"
              name="produto_foto"
              (input)="onFotoInputChange()"
              placeholder="ex.: camiseta01.jpg" />

            <div class="img-preview" *ngIf="!fotoHidden && fotoSrc">
              <img [src]="fotoSrc" alt="Preview da imagem" (error)="onFotoError()" />
              <small class="hint">{{ form.produto_foto || '—' }}</small>
            </div>
            <div class="img-missing" *ngIf="fotoHidden">Imagem não disponível</div>
          </div>
        </div>

        <!-- Botão apenas para LOJAS (o de cores foi removido aqui) -->
        <div class="row" style="gap:10px; margin-top:8px;">
          <button type="button" class="btn" (click)="lojasDialogOpen = true">Selecionar lojas...</button>
        </div>

        <div class="row actions">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <button type="button" class="btn" (click)="cancelar()">Cancelar</button>
        </div>

        <p class="hint">
          A referência é calculada automaticamente (formato: <code>CC - EE - GGXXX</code>) e será confirmada no salvamento.
        </p>
      </form>
    </section>

    <!-- CORES & SKUs -->
    <section class="card" *ngIf="action === 'novo'">
      <h3>Cores & SKUs</h3>

      <div class="row" style="align-items:center; gap:10px;">
        <button class="btn" type="button" (click)="openCoresDialog()">Selecionar cores...</button>
        <span class="hint">Selecionadas: {{ coresSelecionadas.size }}</span>
      </div>

      <div class="row actions">
        <button class="btn btn-primary" type="button" (click)="gerarSkus()">Gerar SKUs (EAN-13)</button>
      </div>

      <div class="sku-table-wrapper" *ngIf="combinacoes.length > 0">
        <table class="sku-table">
          <thead>
            <tr>
              <th>Cor</th>
              <th>Tamanho</th>
              <th>EAN-13</th>
              <th>Preço</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of combinacoes">
              <td>{{ c.cor.Descricao }}</td>
              <td>{{ c.tamanho.Tamanho }}</td>
              <td>{{ c.ean13 }}</td>
              <td><input type="number" step="0.01" [(ngModel)]="c.preco" /></td>
            </tr>
          </tbody>
        </table>

        <div class="row actions">
          <button
            class="btn btn-primary"
            type="button"
            [disabled]="savingSkus || !combinacoes.length || !form.tabela_preco"
            (click)="salvarSkus()">
            {{ savingSkus ? 'Salvando SKUs...' : 'Salvar SKUs' }}
          </button>
        </div>

        <div *ngIf="batchMsg" class="alert success">{{ batchMsg }}</div>
        <div *ngIf="batchErrors.length" class="alert error">
          <div *ngFor="let e of batchErrors">{{ e }}</div>
        </div>
      </div>
    </section>

    <!-- CONSULTAR -->
    <section class="card" *ngIf="action === 'consultar'">
      <h3>Consulta</h3>

      <div class="row two-cols" style="align-items:end;">
        <div class="col">
          <label for="refBusca">Referência</label>
          <input
            id="refBusca"
            type="text"
            #refProcura
            placeholder="Digite a referência e pressione Enter"
            (keyup.enter)="buscarProduto(refProcura.value)" />
        </div>
        <div class="col" style="display:flex; gap:8px;">
          <button class="btn btn-primary" type="button" (click)="buscarProduto(refProcura.value)">Buscar</button>
          <button class="btn" type="button" (click)="limparBusca(refProcura)">Limpar</button>
          <button class="btn" [routerLink]="['/home']">Home</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div class="col col-full">
          <app-produto-lookup
            [usarCampoInterno]="false"
            (selecionado)="onProdutoSelecionado($event)"
            (verVariacoes)="onVerVariacoes($event)">
          </app-produto-lookup>
        </div>
      </div>
    </section>

  </ng-container>

  <!-- ===== MODAL DE LOJAS ===== -->
  <div class="modal-backdrop" *ngIf="lojasDialogOpen">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lojasTitle">
      <div class="modal-header">
        <h4 id="lojasTitle">Selecionar lojas</h4>
        <button type="button" class="btn-icon" (click)="closeLojasDialog()" aria-label="Fechar">×</button>
      </div>
      <div class="modal-body">
        <app-lojas-selector [(selected)]="lojasMarcadas"></app-lojas-selector>
      </div>
      <div class="modal-footer">
        <button class="btn" type="button" (click)="clearLojasMarcadas()">Limpar</button>
        <div class="spacer"></div>
        <button class="btn" type="button" (click)="closeLojasDialog()">Cancelar</button>
        <button class="btn btn-primary" type="button" (click)="confirmLojasDialog()">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL DE CORES ===== -->
  <div class="modal-backdrop" *ngIf="coresDialogOpen">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="coresTitle">
      <div class="modal-header">
        <h4 id="coresTitle">Selecionar cores</h4>
        <button type="button" class="btn-icon" (click)="closeCoresDialog()" aria-label="Fechar">×</button>
      </div>

      <div class="modal-body">
        <div class="color-toolbar">
          <input type="text" placeholder="Filtrar cores por descrição/código..." [(ngModel)]="corFiltro" />
          <div class="color-actions">
            <button class="btn" type="button" (click)="selecionarTodasVisiveis()">Selecionar visíveis</button>
            <button class="btn" type="button" (click)="clearCoresSelecionadas()">Limpar seleção</button>
          </div>
        </div>

        <div class="color-grid">
          <label class="color-card" *ngFor="let c of coresFiltradas">
            <input
              type="checkbox"
              [checked]="(c.Idcor != null) ? coresSelecionadas.has(c.Idcor) : false"
              [disabled]="c.Idcor == null"
              (change)="toggleCor(c.Idcor, $any($event.target).checked)" />
            <span class="swatch" [style.background]="c.Cor || '#ccc'"></span>
            <div class="texts">
              <div class="name">{{ c.Descricao }}</div>
              <div class="code" *ngIf="c.Codigo">({{ c.Codigo }})</div>
            </div>
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <span class="hint">Selecionadas: {{ coresSelecionadas.size }}</span>
        <div class="spacer"></div>
        <button class="btn" type="button" (click)="closeCoresDialog()">Cancelar</button>
        <button class="btn btn-primary" type="button" (click)="confirmCoresDialog()">Aplicar</button>
      </div>
    </div>
  </div>
</div>
