<div class="prod-page">
  <div class="page-header">
    <h2>Produtos</h2>
    <div class="actions-right">
      <button class="btn btn-light" (click)="setAction('novo')">Revenda</button>
      <button class="btn btn-light" (click)="setAction('uso')">Uso & Consumo</button>
      <button class="btn btn-light" (click)="setAction('consultar')">Consultar</button>
      <button class="btn btn-light" [routerLink]="['/home']">Home</button>
    </div>
  </div>

  <!-- mensagens -->
  <div *ngIf="errorMsg" class="alert error">{{ errorMsg }}</div>
  <div *ngIf="fieldErrors.length" class="alert error">
    <div *ngFor="let fe of fieldErrors">
      <strong>{{ fe.field }}:</strong> {{ fe.messages.join('; ') }}
    </div>
  </div>
  <div *ngIf="successMsg" class="alert success">{{ successMsg }}</div>
  <div *ngIf="infoMsg" class="alert info">{{ infoMsg }}</div>

  <div *ngIf="awaitKeyAfterSave" class="alert info">Pressione qualquer tecla para continuar.</div>

  <ng-container *ngIf="!awaitKeyAfterSave">

    <!-- PLACEHOLDER -->
    <section class="card form-placeholder" *ngIf="action === ''">
      <div class="placeholder-inner">
        <p>Para cadastrar um <strong>Produto</strong>, clique em <strong>Revenda</strong> ou <strong>Uso & Consumo</strong>.</p>
        <p>Para consultar/editar, clique em <strong>Consultar</strong>.</p>
      </div>
    </section>

    <!-- NOVO / EDITAR — REV**ENDA** -->
    <section class="card" *ngIf="action === 'novo' || (action === 'editar' && editTipo==='1')">
      <h3>{{ editingId ? 'Editar Produto (Revenda)' : 'Produto Revenda - Novo' }}</h3>

      <form (ngSubmit)="salvar()">
        <!-- Linha 1 -->
        <div class="row">
          <div class="col">
            <label for="referencia">Referência (preview)</label>
            <input id="referencia" type="text" [value]="referenciaPreview" readonly />
          </div>

          <div class="col col-grow">
            <label for="descricao">Descrição*</label>
            <input id="descricao" type="text" [(ngModel)]="form.Descricao" name="descricao" />
          </div>

          <div class="col">
            <label for="descReduzida">Descrição reduzida</label>
            <input id="descReduzida" type="text" [(ngModel)]="form.Desc_reduzida" name="Desc_reduzida" />
          </div>

          <div class="col">
            <label for="ncm">Classificação Fiscal (NCM)*</label>
            <select id="ncm" [(ngModel)]="form.classificacao_fiscal" name="classificacao_fiscal">
              <option [ngValue]="''" disabled>Selecione</option>
              <option *ngFor="let n of ncms" [ngValue]="n.ncm">{{ n.ncm }} — {{ n.descricao || '' }}</option>
            </select>
          </div>
        </div>

        <!-- Linha 2 -->
        <div class="row">
          <div class="col">
            <label for="colecao">Coleção (código)*</label>
            <select id="colecao" [(ngModel)]="form.colecao" name="colecao" (change)="onColecaoChange()">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let cc of colecoesCodigos" [ngValue]="cc">{{ cc }}</option>
            </select>
          </div>

          <div class="col">
            <label for="estacao">Estação*</label>
            <select id="estacao" [(ngModel)]="form.estacao" name="estacao" (change)="onEstacaoChange()">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let e of estacoesDaColecao" [ngValue]="e">{{ e }}</option>
            </select>
          </div>

          <div class="col">
            <label for="grupo">Grupo (código)*</label>
            <select id="grupo" [(ngModel)]="form.grupo" name="grupo" (change)="onGrupoChange()">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let g of grupos" [ngValue]="(g.Codigo || '').toString().padStart(2,'0')">
                {{ (g.Codigo || '').toString().padStart(2,'0') }} — {{ g.Descricao }}
              </option>
            </select>
          </div>

          <div class="col">
            <label for="subgrupo">Subgrupo</label>
            <select id="subgrupo" [(ngModel)]="form.subgrupo" name="subgrupo">
              <option [ngValue]="null">—</option>
              <option *ngFor="let s of subgrupos" [ngValue]="s.Idsubgrupo">{{ s.Descricao }}</option>
            </select>
          </div>

          <div class="col">
            <label for="unidade">Unidade*</label>
            <select id="unidade" [(ngModel)]="form.unidade" name="unidade">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let u of unidades" [ngValue]="u.Idunidade">{{ u.Descricao }}</option>
            </select>
          </div>

          <div class="col">
            <label for="grade">Grade*</label>
            <select id="grade" [(ngModel)]="form.grade" name="grade" (change)="onGradeChange()">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let g of grades" [ngValue]="g.Idgrade">{{ g.Descricao }}</option>
            </select>
          </div>

          <div class="col">
            <label for="tabela">Tabela de Preço*</label>
            <select id="tabela" [(ngModel)]="form.tabela_preco" name="tabela_preco">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let t of tabelasPreco" [ngValue]="t.Idtabela">{{ t.NomeTabela }}</option>
            </select>
          </div>

          <div class="col">
            <label for="preco">Preço de venda*</label>
            <input id="preco" type="number" step="0.01" min="0" [(ngModel)]="form.Preco" name="Preco" />
          </div>
        </div>

        <!-- Linha da IMAGEM -->
        <div class="row row-image">
          <div class="col img-col">
            <label for="produtoFoto">Imagem (nome do arquivo)</label>
            <input
              id="produtoFoto"
              type="text"
              [(ngModel)]="form.produto_foto"
              name="produto_foto"
              (input)="onFotoInputChange()"
              placeholder="ex.: camiseta01.jpg" />

            <div class="img-preview" *ngIf="!fotoHidden && fotoSrc">
              <img [src]="fotoSrc" alt="Preview da imagem" (error)="onFotoError()" />
              <small class="hint">{{ form.produto_foto || '—' }}</small>
            </div>
            <div class="img-missing" *ngIf="fotoHidden">Imagem não disponível</div>
          </div>
        </div>

        <!-- Botões auxiliares -->
        <div class="row" style="gap:10px; margin-top:8px;">
          <button type="button" class="btn" (click)="lojasDialogOpen = true">Selecionar lojas...</button>
        </div>

        <div class="row actions">
          <button type="submit" class="btn btn-primary">{{ editingId ? 'Salvar alterações' : 'Salvar' }}</button>
          <button type="button" class="btn" (click)="cancelar()">Cancelar</button>
        </div>

        <p class="hint">
          A referência é calculada automaticamente (formato: <code>CC - EE - GGXXX</code>) e será confirmada no salvamento.
        </p>
      </form>
    </section>

    <!-- CORES & SKUs -->
    <section class="card" *ngIf="(action === 'novo' && !editingId) || (action==='editar' && editTipo==='1')">
      <h3>Cores & SKUs</h3>

      <div class="row" style="align-items:center; gap:10px;">
        <button class="btn" type="button" (click)="openCoresDialog()">Selecionar cores...</button>
        <span class="hint">Selecionadas: {{ coresSelecionadas.size }}</span>
      </div>

      <div class="row actions">
        <button class="btn btn-primary" type="button" (click)="gerarSkus()">Gerar SKUs (EAN-13)</button>
      </div>

      <div class="sku-table-wrapper" *ngIf="combinacoes.length > 0">
        <table class="sku-table">
          <thead>
            <tr>
              <th>Cor</th>
              <th>Tamanho</th>
              <th>EAN-13</th>
              <th>Preço</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let c of combinacoes">
              <td>{{ c.cor.Descricao }}</td>
              <td>{{ c.tamanho.Tamanho }}</td>
              <td>{{ c.ean13 }}</td>
              <td><input type="number" step="0.01" [(ngModel)]="c.preco" /></td>
            </tr>
          </tbody>
        </table>

        <div class="row actions">
          <button class="btn btn-primary" type="button" [disabled]="savingSkus || !combinacoes.length || !form.tabela_preco" (click)="salvarSkus">
            {{ savingSkus ? 'Salvando SKUs...' : 'Salvar SKUs' }}
          </button>
        </div>

        <div *ngIf="batchMsg" class="alert success">{{ batchMsg }}</div>
        <div *ngIf="batchErrors.length" class="alert error">
          <div *ngFor="let e of batchErrors">{{ e }}</div>
        </div>
      </div>
    </section>

    <!-- NOVO / EDITAR — USO & CONSUMO -->
    <section class="card" *ngIf="action === 'uso' || (action === 'editar' && editTipo==='2')">
      <h3>{{ editingId ? 'Editar Produto (Uso & Consumo)' : 'Produto Uso & Consumo — Novo' }}</h3>

      <form (ngSubmit)="salvarUso()">
        <div class="row">
          <div class="col col-grow">
            <label>Nome*</label>
            <input type="text" [(ngModel)]="formUso.Descricao" name="uso_desc" />
          </div>

          <div class="col">
            <label>NCM*</label>
            <select [(ngModel)]="formUso.classificacao_fiscal" name="uso_ncm">
              <option [ngValue]="''" disabled>Selecione</option>
              <option *ngFor="let n of ncms" [ngValue]="n.ncm">{{ n.ncm }} — {{ n.descricao || '' }}</option>
            </select>
          </div>

          <div class="col">
            <label>Unidade*</label>
            <select [(ngModel)]="formUso.unidade" name="uso_unidade">
              <option [ngValue]="null" disabled>Selecione</option>
              <option *ngFor="let u of unidades" [ngValue]="u.Idunidade">{{ u.Descricao }}</option>
            </select>
          </div>

          <div class="col">
            <label>Ativo?</label>
            <select [(ngModel)]="formUso.ativo" name="uso_ativo">
              <option [ngValue]="true">Sim</option>
              <option [ngValue]="false">Não</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col col-full">
            <label>Descrição</label>
            <input type="text" [(ngModel)]="formUso.descricao_longa" name="uso_descr" />
          </div>
        </div>

        <div class="row actions">
          <button type="submit" class="btn btn-primary">{{ editingId ? 'Salvar alterações' : 'Salvar' }}</button>
          <button type="button" class="btn" (click)="cancelar()">Cancelar</button>
        </div>
      </form>
    </section>

    <!-- CONSULTAR (ListView com filtros restaurados) -->
    <section class="card" *ngIf="action === 'consultar'">
      <h3>Consultar</h3>

      <form [formGroup]="filtrosFG" (ngSubmit)="buscarProdutos()" class="filters">
        <!-- linha 1 -->
        <div class="f-row">
          <div class="fi">
            <label>Tipo</label>
            <select formControlName="tipo">
              <option value="">(todos)</option>
              <option value="1">Revenda</option>
              <option value="2">Uso & Consumo</option>
            </select>
          </div>

          <div class="fi">
            <label>Ativo</label>
            <select formControlName="ativo">
              <option value="all">(todos)</option>
              <option value="true">Ativos</option>
              <option value="false">Inativos</option>
            </select>
          </div>

          <div class="fi">
            <label>Referência</label>
            <input type="text" formControlName="referencia" placeholder="Ex.: 02-01-010" />
          </div>

          <div class="fi col-grow">
            <label>Descrição</label>
            <input type="text" formControlName="descricao" placeholder="Parte do nome..." />
          </div>

          <div class="fi">
            <label>Grupo</label>
            <select formControlName="grupo">
              <option value="">(todos)</option>
              <option *ngFor="let g of grupos" [value]="(g.Codigo || '').toString().padStart(2,'0')">
                {{ (g.Codigo || '').toString().padStart(2,'0') }} — {{ g.Descricao }}
              </option>
            </select>
          </div>
        </div>

        <!-- linha 2 (somente ordenação ativa agora) -->
        <div class="f-row">
          <div class="fi">
            <label>Ordenação</label>
            <select formControlName="ordering">
              <option value="-id">Mais recentes</option>
              <option value="id">Mais antigos</option>
              <option value="Descricao">Descrição (A→Z)</option>
              <option value="-Descricao">Descrição (Z→A)</option>
            </select>
          </div>
        </div>

        <div class="filters-actions">
          <button class="btn btn-primary" type="submit">Aplicar</button>
          <button class="btn" type="button" (click)="limparFiltros()">Limpar</button>
        </div>
      </form>

      <div class="listview-toolbar" *ngIf="rowsPaged.length">
        <div class="left">
          Mostrando <strong>{{ pageStart }}</strong>–<strong>{{ pageEnd }}</strong> de <strong>{{ totalRows }}</strong>
        </div>
        <div class="right">
          Itens por página:
          <select [(ngModel)]="pageSize" (ngModelChange)="page=1">
            <option *ngFor="let n of pageSizeOptions" [ngValue]="n">{{ n }}</option>
          </select>
        </div>
      </div>

      <div class="table-wrap" *ngIf="!loading && rowsPaged.length">
        <table class="table table-full">
          <thead>
            <tr>
              <th (click)="setOrdenacao('id')">ID</th>
              <th (click)="setOrdenacao('Descricao')">Descrição</th>
              <th>Tipo</th>
              <th>NCM</th>
              <th>Unidade</th>
              <th>Ativo</th>
              <th class="col-actions">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of rowsPaged">
              <td class="col-id">{{ p.Idproduto || p.id }}</td>
              <td class="col-text">{{ p.Descricao || p.descricao }}</td>
              <td class="col-text">{{ normalizeTipo(p) === '1' ? 'Revenda' : normalizeTipo(p) === '2' ? 'Uso & Consumo' : '—' }}</td>
              <td class="col-text">{{ p.classificacao_fiscal || '—' }}</td>
              <td class="col-text">{{ p.unidade || p.Unidade || '—' }}</td>
              <td class="col-text">{{ (p.Ativo ?? p.ativo ?? true) ? 'Sim' : 'Não' }}</td>
              <td class="col-actions">
                <div class="actions-wrap" style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button class="btn" (click)="detalharLinha(p)">Detalhar</button>
                  <!-- Editar apenas para Uso & Consumo -->
                  <button class="btn" *ngIf="normalizeTipo(p)==='2'" (click)="editarLinha(p)">Editar</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Paginação -->
        <div class="pagination">
          <button class="btn" [disabled]="page===1" (click)="goFirst()">«</button>
          <button class="btn" [disabled]="page===1" (click)="goPrev()">‹</button>
          <span>Página {{ page }} / {{ totalPages }}</span>
          <button class="btn" [disabled]="page===totalPages" (click)="goNext()">›</button>
          <button class="btn" [disabled]="page===totalPages" (click)="goLast()">»</button>
        </div>
      </div>

      <div class="state" *ngIf="loading">Carregando...</div>
      <div class="state" *ngIf="!loading && !rowsPaged.length">Nenhum produto encontrado.</div>

      <!-- Lookup auxiliar (preservado) -->
      <div class="row" style="margin-top:12px;">
        <div class="col col-full">
          <app-produto-lookup
            [usarCampoInterno]="false"
            (selecionado)="onProdutoSelecionado($event)"
            (verVariacoes)="onVerVariacoes($event)">
          </app-produto-lookup>
        </div>
      </div>
    </section>

  </ng-container>

  <!-- ===== MODAL DE LOJAS ===== -->
  <div class="modal-backdrop" *ngIf="lojasDialogOpen">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="lojasTitle">
      <div class="modal-header">
        <h4 id="lojasTitle">Selecionar lojas</h4>
        <button type="button" class="btn-icon" (click)="closeLojasDialog()" aria-label="Fechar">×</button>
      </div>
      <div class="modal-body">
        <app-lojas-selector [(selected)]="lojasMarcadas"></app-lojas-selector>
      </div>
      <div class="modal-footer">
        <button class="btn" type="button" (click)="clearLojasMarcadas()">Limpar</button>
        <div class="spacer"></div>
        <button class="btn" type="button" (click)="closeLojasDialog()">Cancelar</button>
        <button class="btn btn-primary" type="button" (click)="confirmLojasDialog()">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL DE CORES ===== -->
  <div class="modal-backdrop" *ngIf="coresDialogOpen">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="coresTitle">
      <div class="modal-header">
        <h4 id="coresTitle">Selecionar cores</h4>
        <button type="button" class="btn-icon" (click)="closeCoresDialog()" aria-label="Fechar">×</button>
      </div>

      <div class="modal-body">
        <div class="color-toolbar">
          <input type="text" placeholder="Filtrar cores por descrição/código..." [(ngModel)]="corFiltro" />
          <div class="color-actions">
            <button class="btn" type="button" (click)="selecionarTodasVisiveis()">Selecionar visíveis</button>
            <button class="btn" type="button" (click)="clearCoresSelecionadas()">Limpar seleção</button>
          </div>
        </div>

        <div class="cores-inline"
             style="display:flex; flex-wrap:wrap; gap:8px 14px; align-items:center; border:1px solid #e5e7eb; border-radius:8px; padding:10px;">
          <label *ngFor="let c of coresFiltradas" style="display:inline-flex; align-items:center; gap:6px; white-space:nowrap;">
            <input type="checkbox"
                   [checked]="(c.Idcor != null) ? coresSelecionadas.has(c.Idcor) : false"
                   [disabled]="c.Idcor == null"
                   (change)="toggleCor(c.Idcor, $any($event.target).checked)"
                   style="transform:scale(.9); margin:0;" />
            <span>{{ c.Descricao }}</span>
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <span class="hint">Selecionadas: {{ coresSelecionadas.size }}</span>
        <div class="spacer"></div>
        <button class="btn" type="button" (click)="closeCoresDialog()">Cancelar</button>
        <button class="btn btn-primary" type="button" (click)="confirmCoresDialog()">Aplicar</button>
      </div>
    </div>
  </div>

  <!-- ===== MODAL DE DETALHE (REVENDA) ===== -->
  <div class="modal-backdrop" *ngIf="detailDialogOpen">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="detalheTitle">
      <div class="modal-header">
        <h4 id="detalheTitle">Detalhe do Produto (Revenda)</h4>
        <button type="button" class="btn-icon" (click)="closeDetailDialog()" aria-label="Fechar">×</button>
      </div>

      <div class="modal-body" *ngIf="detailData">
        <div class="row">
          <div class="col col-grow">
            <div><strong>Descrição:</strong> {{ detailData.Descricao || detailData.descricao || '—' }}</div>
            <div><strong>Referência:</strong> {{ detailData.referencia || '—' }}</div>
            <div><strong>NCM:</strong> {{ detailData.classificacao_fiscal || detailData.NCM || '—' }}</div>
            <div><strong>Unidade:</strong> {{ detailData.unidade || detailData.Unidade || '—' }}</div>
            <div><strong>Ativo:</strong> {{ (detailData.Ativo ?? detailData.ativo ?? true) ? 'Sim' : 'Não' }}</div>

            <!-- === Ações dentro do modal (VLSI / VFW) + ATIVAR/INATIVAR === -->
            <div class="detail-actions">
              <button class="btn btn-primary" type="button"
                      [disabled]="!detailProdutoId"
                      (click)="detailSkuOverlayOpen = true">
                Ver SKUs
              </button>
              <button class="btn" type="button"
                      [disabled]="!detailProdutoId"
                      (click)="detailPrecoOverlayOpen = true">
                Ver Tabela/Preço
              </button>

              <!-- NOVO: botão de status -->
              <button class="btn" type="button"
                      [disabled]="!detailProdutoId || detailLoading"
                      (click)="toggleDetailStatus()">
                {{ isDetailAtivo() ? 'Desativar produto' : 'Ativar produto' }}
              </button>
            </div> 
          </div>

          <div class="col" style="min-width:220px;">
            <div class="img-preview" *ngIf="!detailFotoHidden && detailFotoSrc">
              <img [src]="detailFotoSrc" alt="Foto do produto"
                   (error)="onDetailFotoError()" />
              <small class="hint">{{ detailData.produto_foto || '—' }}</small>
            </div>
            <div class="img-missing" *ngIf="detailFotoHidden">Imagem não disponível</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="spacer"></div>
        <button class="btn btn-primary" type="button" (click)="closeDetailDialog()">Fechar</button>
      </div>
    </div>
  </div>

  <!-- === SOBRETELAS abertas a partir do modal de Detalhe === -->
  <app-produtos-sku-overlay
    *ngIf="detailSkuOverlayOpen"
    [aberto]="detailSkuOverlayOpen"
    [produtoId]="detailProdutoId!"]
    [referencia]="detailReferencia"
    (close)="detailSkuOverlayOpen = false">
  </app-produtos-sku-overlay>

  <app-produtos-preco-overlay
    *ngIf="detailPrecoOverlayOpen"
    [aberto]="detailPrecoOverlayOpen"
    [produtoId]="detailProdutoId!"]
    [referencia]="detailReferencia"
    (close)="detailPrecoOverlayOpen = false">
  </app-produtos-preco-overlay>

</div>
