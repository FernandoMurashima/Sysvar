<!-- Toolbar interna opcional -->
<div *ngIf="usarCampoInterno" class="pl-toolbar">
  <label>Referência</label>
  <div class="pl-toolbar-actions">
    <input type="text" #ref (keyup.enter)="buscarComReferencia(ref.value)" placeholder="Digite a referência e pressione Enter" />
    <button class="btn btn-primary" type="button" (click)="buscarComReferencia(ref.value)">Buscar</button>
  </div>
</div>

<!-- Mensagens -->
<div *ngIf="erroMsg()" class="alert error">{{ erroMsg() }}</div>

<!-- Card -->
<div *ngIf="resultado() as p" class="pl-card">
  <div class="pl-card-grid">
    <div>
      <!-- Linha 1 -->
      <div class="pl-grid pl-line1">
        <div class="pl-field">
          <div class="pl-label">Referência</div>
          <div class="pl-value">{{ p.Referencia }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">Coleção</div>
          <div class="pl-value">{{ p.colecao_desc || '—' }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">NCM</div>
          <div class="pl-value">{{ p.classificacao_fiscal || '—' }}</div>
        </div>
      </div>

      <!-- Linha 2 -->
      <div class="pl-grid pl-line2">
        <div class="pl-field pl-col-span-2">
          <div class="pl-label">Descrição</div>
          <div class="pl-value">{{ p.Nome_produto }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">Grupo</div>
          <div class="pl-value">{{ p.grupo_desc || '—' }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">Subgrupo</div>
          <div class="pl-value">{{ p.subgrupo_desc || '—' }}</div>
        </div>
      </div>

      <!-- Linha 3 -->
      <div class="pl-grid pl-line3">
        <div class="pl-field">
          <div class="pl-label">Unidade</div>
          <div class="pl-value">{{ p.unidade_desc || '—' }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">Situação</div>
          <div class="pl-value">
            <span class="pl-badge" [class.pl-badge-ok]="p.Ativo" [class.pl-badge-no]="!p.Ativo">
              {{ p.Ativo ? 'Ativo: Sim' : 'Ativo: Não' }}
            </span>
          </div>
        </div>
      </div>

      <div class="pl-actions" style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-primary" type="button" (click)="onToggleStatus(p)" [disabled]="loading()">
          {{ p.Ativo ? 'Desativar produto' : 'Ativar produto' }}
        </button>

        <button class="btn" type="button" (click)="carregarSkus(p)">
          Ver SKUs
        </button>
        <button class="btn" type="button" (click)="carregarTabelas(p)">
          Ver Tabelas/Preços
        </button>
      </div>

      <!-- Detalhe: SKUs -->
      <div *ngIf="mostrandoSkus()">
        <h4 style="margin:12px 0 6px;">SKUs</h4>
        <div *ngIf="skus() === null" class="pl-value">Carregando SKUs...</div>
        <div *ngIf="skus() as rows">
          <div *ngIf="rows.length === 0" class="pl-value">Nenhum SKU encontrado.</div>
          <table *ngIf="rows.length" class="sku-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 8px;">EAN-13</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 8px;">Cor</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 8px;">Tamanho</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 8px;">Ativo</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of rows">
                <td style="padding:6px 8px;">{{ r.ean13 }}</td>
                <td style="padding:6px 8px;">
                  <span>{{ r.cor || '—' }}</span>
                  <small *ngIf="r.cor_codigo"> ({{ r.cor_codigo }})</small>
                </td>
                <td style="padding:6px 8px;">{{ r.tamanho || '—' }}</td>
                <td style="padding:6px 8px;">{{ r.ativo ? 'Sim' : 'Não' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Detalhe: Tabelas / Preços -->
      <div *ngIf="mostrandoTabelas()">
        <h4 style="margin:12px 0 6px;">Tabelas / Preços</h4>
        <div *ngIf="tabelas() === null" class="pl-value">Carregando tabelas...</div>
        <div *ngIf="tabelas() as tabs">
          <div *ngIf="tabs.length === 0" class="pl-value">Nenhum preço encontrado.</div>

          <div *ngFor="let t of tabs" style="margin-bottom:10px;">
            <div class="pl-label" style="font-weight:600; margin-bottom:6px;">
              {{ t.tabela_nome }} (ID: {{ t.tabela_id }})
            </div>
            <table class="sku-table" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 8px;">EAN-13</th>
                  <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 8px;">Preço</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let it of t.itens">
                  <td style="padding:6px 8px;">{{ it.ean13 }}</td>
                  <td style="padding:6px 8px;">{{ it.preco | number:'1.2-2' }}</td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>

    <!-- Foto -->
    <div>
      <div class="pl-photo">
        <img
          *ngIf="!imageHidden() && imgSrc()"
          [src]="imgSrc()"
          alt="Foto do produto"
          (error)="onImageError($event)"
        />
        <div class="pl-photo-name">{{ (resultado()?.produto_foto || '—') }}</div>
        <div *ngIf="imageHidden()" class="pl-photo-missing">Imagem não disponível</div>
      </div>
    </div>
  </div>
</div>
