<!-- Toolbar interna opcional -->
<div *ngIf="usarCampoInterno" class="pl-toolbar">
  <label>Referência</label>
  <div class="pl-toolbar-actions">
    <input type="text" #ref (keyup.enter)="buscarComReferencia(ref.value)" placeholder="Digite a referência e pressione Enter" />
    <button class="btn btn-primary" type="button" (click)="buscarComReferencia(ref.value)">Buscar</button>
  </div>
</div>

<!-- Mensagens -->
<div *ngIf="erroMsg()" class="alert error">{{ erroMsg() }}</div>

<!-- Card -->
<div *ngIf="resultado() as p" class="pl-card">
  <div class="pl-card-grid">
    <div>
      <!-- Linha 1 -->
      <div class="pl-grid pl-line1">
        <div class="pl-field">
          <div class="pl-label">Referência</div>
          <div class="pl-value">{{ p.Referencia }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">Coleção</div>
          <div class="pl-value">{{ p.colecao_desc || '—' }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">NCM</div>
          <div class="pl-value">{{ p.classificacao_fiscal || '—' }}</div>
        </div>
      </div>

      <!-- Linha 2 -->
      <div class="pl-grid pl-line2">
        <div class="pl-field pl-col-span-2">
          <div class="pl-label">Descrição</div>
          <div class="pl-value">{{ p.Nome_produto }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">Grupo</div>
          <div class="pl-value">{{ p.grupo_desc || '—' }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">Subgrupo</div>
          <div class="pl-value">{{ p.subgrupo_desc || '—' }}</div>
        </div>
      </div>

      <!-- Linha 3 -->
      <div class="pl-grid pl-line3">
        <div class="pl-field">
          <div class="pl-label">Unidade</div>
          <div class="pl-value">{{ p.unidade_desc || '—' }}</div>
        </div>
        <div class="pl-field">
          <div class="pl-label">Situação</div>
          <div class="pl-value">
            <span class="pl-badge" [class.pl-badge-ok]="p.Ativo" [class.pl-badge-no]="!p.Ativo">
              {{ p.Ativo ? 'Ativo: Sim' : 'Ativo: Não' }}
            </span>
          </div>
        </div>
      </div>

      <div class="pl-actions" style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-primary" type="button" (click)="onToggleStatus(p)" [disabled]="loading()">
          {{ p.Ativo ? 'Desativar produto' : 'Ativar produto' }}
        </button>

        <!-- Botões que apenas abrem as SOBRETELAS -->
        <button class="btn" type="button" (click)="openSkusOverlay(p)">Ver SKUs</button>
        <button class="btn" type="button" (click)="openPrecoOverlay(p)">Ver Tabela/Preço</button>
      </div>
    </div>

    <!-- Foto -->
    <div>
      <div class="pl-photo">
        <img
          *ngIf="!imageHidden() && imgSrc()"
          [src]="imgSrc()"
          alt="Foto do produto"
          (error)="onImageError()"
        />
        <div class="pl-photo-name">{{ (resultado()?.produto_foto || '—') }}</div>
        <div *ngIf="imageHidden()" class="pl-photo-missing">Imagem não disponível</div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL de senha -->
<div *ngIf="askPwdOpen()" class="pl-modal-backdrop">
  <div class="pl-modal">
    <h4>Confirmar desativação</h4>
    <p>Digite sua senha para confirmar a desativação do produto.</p>

    <label class="pl-label" for="pwdInput">Senha</label>
    <input
      id="pwdInput"
      type="password"
      [ngModel]="pwdValue()"
      (ngModelChange)="pwdValue.set($event)"
      (keyup.enter)="confirmPassword()"
      autofocus
    />

    <div class="pl-modal-actions">
      <button class="btn btn-primary" type="button" (click)="confirmPassword()">Confirmar</button>
      <button class="btn" type="button" (click)="cancelPassword()">Cancelar</button>
    </div>
  </div>
</div>

<!-- SOBRETELA DE SKUs -->
<app-produtos-sku-overlay
  *ngIf="overlayOpen()"
  [aberto]="overlayOpen()"
  [produtoId]="overlayProdutoId()!"
  [referencia]="overlayRef()"
  (close)="closeSkusOverlay()">
</app-produtos-sku-overlay>

<!-- SOBRETELA DE PREÇO -->
<app-produtos-preco-overlay
  *ngIf="precoOverlayOpen()"
  [aberto]="precoOverlayOpen()"
  [produtoId]="precoOverlayProdutoId()!"
  [referencia]="precoOverlayRef()"
  (close)="closePrecoOverlay()">
</app-produtos-preco-overlay>
