<div class="pc-page">
  
  <header class="toolbar">
    <h2>Pedido de Compra</h2>
    <div class="toolbar-actions">
      <button class="btn primary" (click)="setAction('novo')">Novo</button>
      <button class="btn primary" (click)="setAction('consultar')">Consultar</button>
      <button class="btn primary" [routerLink]="['/home']">Home</button>
    </div>
  </header>
  
  <div *ngIf="errorMsg" class="alert error">{{ errorMsg }}</div>
  <div *ngIf="fieldErrors.length" class="alert error">
    <div *ngFor="let fe of fieldErrors">
      <strong>{{ fe.field }}:</strong> {{ fe.messages.join('; ') }}
    </div>
  </div>
  <div *ngIf="successMsg" class="alert success">{{ successMsg }}</div>
  <div *ngIf="infoMsg" class="alert info">{{ infoMsg }}</div>

  <!-- PLACEHOLDER -->
  <section class="card form-placeholder" *ngIf="action === ''">
    <div class="placeholder-inner">
      <p>Para cadastrar um <strong>Pedido de Compra</strong>, clique em <strong>Novo</strong>.</p>
      <p>Para consultar/filtrar, clique em <strong>Consultar</strong>.</p>
    </div>
  </section>

  <!-- NOVO -->
  <section class="card" *ngIf="action === 'novo'">
    <h3>Novo Pedido de Compra</h3>

    <form (ngSubmit)="salvarNovo()" [formGroup]="novoForm">

      <!-- 1ª linha: Fornecedor (ID + Nome) | Loja | Tipo de Pedido -->
      <div class="form-row row-3">
        <!-- Fornecedor (ID + Nome ao lado) -->
        <div class="field-block">
          <div class="label">Fornecedor</div>
          <div class="inline-pair">
            <input class="id-input" type="number" formControlName="Idfornecedor" placeholder="ID" (blur)="0" />
            <input class="name-input" type="text" [value]="fornecedorNome" placeholder="Nome do fornecedor" readonly />
          </div>
          <small class="muted warn" *ngIf="novoForm.value.Idfornecedor && !fornecedorValido">
            Fornecedor inválido
          </small>
        </div>

        <!-- Loja -->
        <div class="field-block">
          <div class="label">Loja</div>
          <select formControlName="Idloja">
            <option [ngValue]="null">(selecione)</option>
            <option *ngFor="let l of lojas" [ngValue]="l.id">{{ l.id }} — {{ l.nome }}</option>
          </select>
          <small class="muted warn" *ngIf="novoForm.value.Idloja && !lojaValida">Loja inválida</small>
        </div>

        <!-- Tipo de Pedido -->
        <div class="field-block">
          <div class="label">Tipo de Pedido</div>
          <select formControlName="tipo_pedido">
            <option value="revenda">Revenda</option>
            <option value="consumo">Uso/Consumo</option>
          </select>
        </div>
      </div>

      <!-- 2ª linha: Data do Pedido | Data de Entrega -->
      <div class="form-row row-2">
        <div class="field-block">
          <div class="label">Data do Pedido</div>
          <input type="date" formControlName="Datapedido" />
        </div>

        <div class="field-block">
          <div class="label">Data de Entrega</div>
          <input type="date" formControlName="Dataentrega" />
        </div>
      </div>

      <!-- Forma de Pagamento -->
      <div class="card" style="margin:8px 0; padding:10px;">
        <h4>Forma de Pagamento</h4>
        <div class="form-row row-2">
          <div class="field-block">
            <div class="label">Código</div>
            <input type="text" formControlName="forma_codigo" placeholder="Ex.: 01 ou 02" />
            <small class="muted">Se preencher código, ele será priorizado.</small>
          </div>

          <div class="field-block">
            <div class="label">Selecionar</div>
            <select formControlName="forma_id">
              <option [ngValue]="null">(não selecionar)</option>
              <option *ngFor="let f of formas" [ngValue]="f.Idformapagamento">
                {{ f.codigo }} — {{ f.descricao }} ({{ f.num_parcelas }}x)
              </option>
            </select>
          </div>
        </div>
      </div>

      <!-- Itens -->
      <div class="items" style="margin-top:12px;" formArrayName="itens">
        <h4>Itens</h4>
        <table>
          <thead>
            <tr>
              <th style="width:120px">Produto (ID)</th>
              <th>Descrição</th>
              <th style="width:120px">Qtde</th>
              <th style="width:140px">Preço</th>
              <th style="width:140px">Desconto</th>
              <th style="width:140px">SKU (opcional)</th>
              <th style="width:140px">Total Item</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let _ of itensFA.controls; let i = index" [formGroupName]="i">
              <td><input type="number" formControlName="Idproduto" (blur)="onProdutoBlur(i)" /></td>
              <td><input type="text" formControlName="produto_nome" readonly /></td>
              <td><input type="number" step="0.0001" formControlName="Qtp_pc" (input)="recalcItem(i)" /></td>
              <td><input type="number" step="0.01" formControlName="valorunitario" (input)="recalcItem(i)" /></td>
              <td><input type="number" step="0.01" formControlName="Desconto" (input)="recalcItem(i)" /></td>
              <td><input type="number" formControlName="Idprodutodetalhe" /></td>
              <td><input type="number" formControlName="total_item" readonly /></td>
              <td><button class="btn" type="button" (click)="removeItem(i)">−</button></td>
            </tr>
          </tbody>
        </table>

        <div class="items-actions stacked">
          <button class="btn" type="button" (click)="addItem()">+ Adicionar item</button>
        </div>

        <div class="total-line">
          Total do Pedido: <strong>{{ totalPedido | number:'1.2-2' }}</strong>
        </div>
      </div>

      <div class="actions actions-form spaced-top">
        <button class="btn btn-primary" type="submit" [disabled]="salvando || !fornecedorValido || !lojaValida">
          Salvar
        </button>
        <button class="btn" type="button" (click)="cancelarNovo()">Cancelar</button>
      </div>
    </form>
  </section>


  <!-- CONSULTAR -->
  <section class="card" *ngIf="action === 'consultar'">
    <h3>Consultar</h3>

    <form [formGroup]="filtrosForm" (ngSubmit)="buscar()" class="filters">
      <!-- 1ª linha: Status + Tipo (compactos, lado a lado) -->
      <div class="field-group1">
        <div class="fi" id="status">
          <label>Status:</label>
          <select formControlName="status">
            <option value="">(todos)</option>
            <option value="AB">AB (Aberto)</option>
            <option value="AP">AP (Aprovado)</option>
            <option value="CA">CA (Cancelado)</option>
            <option value="AT">AT (Atendido)</option>
            <option value="PA">PA (Parcial aberto)</option>
            <option value="PE">PE (Parcial encerrado)</option>
          </select>
        </div>

        <div class="fi" id="tipo">
          <label>Tipo:</label>
          <select formControlName="tipo_pedido">
            <option value="">(todos)</option>
            <option value="revenda">Revenda</option>
            <option value="uso/consumo">Uso/Consumo</option>
          </select>
        </div>

        <div class="fi" id="fornecedor">
          <label>Fornecedor:</label>
          <input type="text" formControlName="q_fornecedor" placeholder="ID ou Nome"/>
        </div>

        <div class="fi" id="loja">
          <label>Loja:</label>
          <input type="text" formControlName="loja" placeholder="ID"/>
        </div>
      
      </div>

      <!-- 3ª linha: Emissão | Entrega -->
      <div class="f-row-3">
        <div class="range-line">
          <label class="inline">Emissão:</label>
          <input type="date" formControlName="emissao_de" />
          <span class="sep">até</span>
          <input type="date" formControlName="emissao_ate" />
        </div>

        <div class="range-line">
          <label class="inline">Entrega:</label>
          <input type="date" formControlName="entrega_de" />
          <span class="sep">até</span>
          <input type="date" formControlName="entrega_ate" />
        </div>
      </div>

      <div class="filters-actions">
        <button class="btn btn-primary" type="submit">Aplicar</button>
        <button class="btn" type="button" (click)="limparFiltros()">Limpar</button>
      </div>
    </form>

    <div class="state" *ngIf="carregando()">Carregando...</div>

    <div class="table-wrap" *ngIf="!carregando() && rows().length > 0">
      <table class="table table-full">
        <thead>
          <tr>
            <th (click)="setOrdenacao('Datapedido')">Data Pedido</th>
            <th (click)="setOrdenacao('Dataentrega')">Data Entrega</th>
            <th (click)="setOrdenacao('Idpedidocompra')">Código Compra</th>
            <th (click)="setOrdenacao('Idfornecedor__Nome_fornecedor')">Nome Fornecedor</th>
            <th (click)="setOrdenacao('Status')">Status</th>
            <th (click)="setOrdenacao('Valorpedido')">Valor Pedido</th>
            <th class="col-actions">Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of rows()">
            <td class="col-date">{{ p.Datapedido | date:'dd/MM/yyyy' }}</td>
            <td class="col-date">{{ p.Dataentrega | date:'dd/MM/yyyy' }}</td>
            <td class="col-id">{{ p.Idpedidocompra }}</td>
            <td class="col-text">{{ p.fornecedor_nome }}</td>
            <td class="col-status">{{ p.Status }}</td>
            <td class="col-money">{{ p.Valorpedido | number:'1.2-2' }}</td>
            <td class="col-actions">
              <div class="actions-wrap">
                <button class="btn btn-primary" *ngIf="p.Status === 'AB'" (click)="aprovarLinha(p)" title="Aprovar">Aprovar</button>
                <button class="btn" *ngIf="p.Status === 'AB'" (click)="editarLinha(p)" title="Editar">Editar</button>
                <button class="btn btn-danger" *ngIf="p.Status === 'AB' || p.Status === 'AP'" (click)="cancelarLinha(p)" title="Cancelar">Cancelar</button>
                <button class="btn btn-light" *ngIf="p.Status === 'CA'" (click)="reabrirLinha(p)" title="Reabrir">Reabrir</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- EDITAR -->
  <section class="card" *ngIf="action === 'editar'">
    <h3>Edição de Pedido #{{ editingId }}</h3>

    <div class="edit-inline-row">
      <div class="pair">
        <label class="inline">Data de Entrega:</label>
        <input type="date" [formControl]="editHeaderForm.controls.Dataentrega" />
      </div>

      <div class="pair">
        <label class="inline">Código:</label>
        <input type="text" [formControl]="fpCodigoCtrl" placeholder="Ex.: 01" />
      </div>

      <div class="pair">
        <label class="inline">Descrição:</label>
        <input type="text" class="desc-readonly" [value]="fpDetalhe || ''" readonly />
      </div>

      <div class="pair">
        <label class="inline">Selecionar:</label>
        <select [formControl]="fpSelectCtrl">
          <option [ngValue]="null">(não selecionar)</option>
          <option *ngFor="let f of formas" [ngValue]="f.Idformapagamento">
            {{ f.codigo }} — {{ f.descricao }} ({{ f.num_parcelas }}x)
          </option>
        </select>
      </div>

      <div class="pair apply">
        <button class="btn btn-primary" type="button" (click)="aplicarFormaPagamentoEditar()">
          Aplicar / Recalcular parcelas
        </button>
      </div>
    </div>

    <div *ngIf="fpParcelas?.length" style="margin-top:10px;">
      <h5>Parcelas</h5>
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Prazo (dias)</th>
            <th>Vencimento</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of fpParcelas">
            <td>{{ p.parcela }}</td>
            <td>{{ p.prazo_dias ?? '—' }}</td>
            <td>{{ p.vencimento | date:'dd/MM/yyyy' }}</td>
            <td>{{ p.valor | number:'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <form [formGroup]="editForm" style="margin-top:12px;">
      <div class="items">
        <h4>Itens</h4>
        <table>
          <thead>
            <tr>
              <th style="width:120px">Produto (ID)</th>
              <th>Descrição</th>
              <th style="width:120px">Qtde</th>
              <th style="width:140px">Preço</th>
              <th style="width:140px">Desconto</th>
              <th style="width:140px">Total Item</th>
            </tr>
          </thead>
          <tbody formArrayName="itens">
            <tr *ngFor="let g of editItensControls; let i = index" [formGroupName]="i">
              <td><input type="number" formControlName="Idproduto" readonly /></td>
              <td><input type="text" formControlName="produto_desc" readonly /></td>
              <td><input type="number" step="0.0001" formControlName="Qtp_pc" (input)="recalcEdit(i)" /></td>
              <td><input type="number" step="0.01" formControlName="valorunitario" (input)="recalcEdit(i)" /></td>
              <td><input type="number" step="0.01" formControlName="Desconto" (input)="recalcEdit(i)" /></td>
              <td><input type="number" formControlName="Total_item" readonly /></td>
            </tr>
          </tbody>
        </table>
      </div>
    </form>

    <div class="actions" style="margin-top:10px;">
      <button class="btn btn-primary" (click)="salvarEdicao()">Salvar alterações</button>
      <button class="btn" (click)="cancelarEdicao()">Cancelar</button>
    </div>
  </section>
</div>
