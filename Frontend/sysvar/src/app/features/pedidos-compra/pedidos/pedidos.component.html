<div class="pc-page">
  <div class="page-header">
    <h2>Pedidos de Compra</h2>
    <div class="actions-right">
      <button class="btn btn-light" (click)="setAction('novo')">Novo</button>
      <button class="btn btn-light" (click)="setAction('consultar')">Consultar</button>
    </div>
  </div>

  <div *ngIf="errorMsg" class="alert error">{{ errorMsg }}</div>
  <div *ngIf="fieldErrors.length" class="alert error">
    <div *ngFor="let fe of fieldErrors">
      <strong>{{ fe.field }}:</strong> {{ fe.messages.join('; ') }}
    </div>
  </div>
  <div *ngIf="successMsg" class="alert success">{{ successMsg }}</div>
  <div *ngIf="infoMsg" class="alert info">{{ infoMsg }}</div>

  <!-- PLACEHOLDER -->
  <section class="card form-placeholder" *ngIf="action === ''">
    <div class="placeholder-inner">
      <p>Para cadastrar um <strong>Pedido de Compra</strong>, clique em <strong>Novo</strong>.</p>
      <p>Para consultar/filtrar, clique em <strong>Consultar</strong>.</p>
    </div>
  </section>

  <!-- NOVO -->
  <section class="card" *ngIf="action === 'novo'">
    <h3>Novo Pedido de Compra</h3>

    <form (ngSubmit)="salvarNovo()" [formGroup]="novoForm">
      <!-- Linha: Fornecedor | Loja -->
      <div class="form-row four-cols">
        <div class="label">Fornecedor</div>
        <div class="field">
          <div class="inline">
            <input class="id-input" type="number" formControlName="Idfornecedor" placeholder="ID" />
            <input class="name-input" type="text" [value]="fornecedorNome" placeholder="Nome do fornecedor" readonly />
          </div>
          <small class="muted warn" *ngIf="novoForm.value.Idfornecedor && !fornecedorValido">
            Fornecedor inválido
          </small>
        </div>

        <div class="label">Loja</div>
        <div class="field">
          <select formControlName="Idloja">
            <option [ngValue]="null">(selecione)</option>
            <option *ngFor="let l of lojas" [ngValue]="l.id">{{ l.id }} — {{ l.nome }}</option>
          </select>
          <small class="muted warn" *ngIf="novoForm.value.Idloja && !lojaValida">Loja inválida</small>
        </div>
      </div>

      <!-- Linha: Data do Pedido | Data de Entrega -->
      <div class="form-row two-cols">
        <div class="label">Data do Pedido</div>
        <div class="field">
          <input type="date" formControlName="Datapedido" />
        </div>

        <div class="label">Data de Entrega</div>
        <div class="field">
          <input type="date" formControlName="Dataentrega" />
        </div>
      </div>

      <!-- Linha: Tipo de Pedido (em linha separada, sem mexer layout) -->
      <div class="form-row two-cols">
        <div class="label">Tipo de Pedido</div>
        <div class="field">
          <select formControlName="tipo_pedido">
            <option value="revenda">Revenda</option>
            <option value="consumo">Uso/Consumo</option>
          </select>
        </div>
      </div>

      <!-- ITENS -->
      <div class="items" style="margin-top:12px;" formArrayName="itens">
        <h4>Itens</h4>
        <table>
          <thead>
            <tr>
              <th style="width:120px">Produto (ID)</th>
              <th>Descrição</th>
              <th style="width:120px">Qtde</th>
              <th style="width:140px">Preço</th>
              <th style="width:140px">Desconto</th>
              <th style="width:140px">SKU (opcional)</th>
              <th style="width:140px">Total Item</th>
              <th style="width:60px"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let _ of itensFA.controls; let i = index" [formGroupName]="i">
              <td><input type="number" formControlName="Idproduto" (blur)="onProdutoBlur(i)" /></td>
              <td><input type="text" formControlName="produto_nome" readonly /></td>
              <td><input type="number" step="0.0001" formControlName="Qtp_pc" (input)="recalcItem(i)" /></td>
              <td><input type="number" step="0.01" formControlName="valorunitario" (input)="recalcItem(i)" /></td>
              <td><input type="number" step="0.01" formControlName="Desconto" (input)="recalcItem(i)" /></td>
              <td><input type="number" formControlName="Idprodutodetalhe" /></td>
              <td><input type="number" formControlName="total_item" readonly /></td>
              <td><button class="btn" type="button" (click)="removeItem(i)">−</button></td>
            </tr>
          </tbody>
        </table>
        <div class="items-actions">
          <button class="btn" type="button" (click)="addItem()">+ Adicionar item</button>
          <div class="total">Total do Pedido: <strong>{{ totalPedido | number:'1.2-2' }}</strong></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit" [disabled]="salvando || !fornecedorValido || !lojaValida">
          Salvar
        </button>
        <!-- NOVO: botão Voltar/Cancelar (lado do Salvar) -->
        <button class="btn" type="button" (click)="cancelarNovo()">Cancelar</button>
      </div>
    </form>
  </section>

  <!-- CONSULTAR -->
  <section class="card" *ngIf="action === 'consultar'">
    <h3>Consultar</h3>

    <form [formGroup]="filtrosForm" (ngSubmit)="buscar()" class="filters-grid">
      <label>Status
        <select formControlName="status">
          <option value="">(todos)</option>
          <option value="AB">AB (Aberto)</option>
          <option value="AP">AP (Aprovado)</option>
          <option value="CA">CA (Cancelado)</option>
          <option value="AT">AT (Atendido)</option>
          <option value="PA">PA (Parcial aberto)</option>
          <option value="PE">PE (Parcial encerrado)</option>
        </select>
      </label>
      <label>Fornecedor (ID ou Nome)
        <input type="text" formControlName="q_fornecedor" placeholder="ex.: 1 ou 'Fornecedor 01'"/>
      </label>
      <label>Loja (ID ou Nome)
        <input type="text" formControlName="loja" placeholder="ex.: 1 ou 'Centro'"/>
      </label>

      <!-- Linha única das datas -->
      <div class="filters-dates">
        <div>
          <span>Emissão:</span>
          <input type="date" formControlName="emissao_de" />
          <span class="sep">até</span>
          <input type="date" formControlName="emissao_ate" />
        </div>
        <div>
          <span>Entrega:</span>
          <input type="date" formControlName="entrega_de" />
          <span class="sep">até</span>
          <input type="date" formControlName="entrega_ate" />
        </div>
      </div>

      <div class="filters-actions">
        <button class="btn btn-primary" type="submit">Aplicar</button>
        <button class="btn" type="button" (click)="limparFiltros()">Limpar</button>
      </div>
    </form>

    <div class="state" *ngIf="carregando()">Carregando...</div>

    <div class="table-wrap" *ngIf="!carregando() && rows().length > 0">
      <table>
        <thead>
          <tr>
            <th (click)="setOrdenacao('Datapedido')">Data do Pedido</th>
            <th (click)="setOrdenacao('Dataentrega')">Data de Entrega</th>
            <th (click)="setOrdenacao('Idpedidocompra')">Nº</th>
            <th (click)="setOrdenacao('Idfornecedor__Nome_fornecedor')">Fornecedor</th>
            <th (click)="setOrdenacao('Status')">Status</th>
            <th (click)="setOrdenacao('Valorpedido')">Total</th>
            <th>Loja</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of rows()">
            <td>{{ p.Datapedido | date:'dd/MM/yyyy' }}</td>
            <td>{{ p.Dataentrega | date:'dd/MM/yyyy' }}</td>
            <td>{{ p.Idpedidocompra }}</td>
            <td>{{ p.fornecedor_nome }}</td>
            <td>{{ p.Status }}</td>
            <td>{{ p.Valorpedido | number:'1.2-2' }}</td>
            <td>{{ p.loja_nome }}</td>
            <td style="white-space:nowrap; display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn btn-primary" *ngIf="p.Status === 'AB'" (click)="aprovarLinha(p)" title="Aprovar">Aprovar</button>
              <button class="btn" *ngIf="p.Status === 'AB'" (click)="editarLinha(p)" title="Editar">Editar</button>
              <button class="btn btn-danger" *ngIf="p.Status === 'AB' || p.Status === 'AP'" (click)="cancelarLinha(p)" title="Cancelar">Cancelar</button>
              <button class="btn btn-light" *ngIf="p.Status === 'CA'" (click)="reabrirLinha(p)" title="Reabrir">Reabrir</button>
              <span *ngIf="p.Status !== 'AB' && p.Status !== 'AP' && p.Status !== 'CA'" class="muted">—</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- EDITAR -->
  <section class="card" *ngIf="action === 'editar'">
    <h3>Edição de Pedido #{{ editingId }}</h3>

    <form class="grid" [formGroup]="editHeaderForm">
      <label> Data de Entrega
        <input type="date" formControlName="Dataentrega" />
      </label>
    </form>

    <form [formGroup]="editForm" style="margin-top:12px;">
      <div class="items">
        <h4>Itens</h4>
        <table>
          <thead>
            <tr>
              <th style="width:120px">Produto (ID)</th>
              <th>Descrição</th>
              <th style="width:120px">Qtde</th>
              <th style="width:140px">Preço</th>
              <th style="width:140px">Desconto</th>
              <th style="width:140px">Total Item</th>
            </tr>
          </thead>
          <tbody formArrayName="itens">
            <tr *ngFor="let g of editItensControls; let i = index" [formGroupName]="i">
              <td><input type="number" formControlName="Idproduto" readonly /></td>
              <td><input type="text" formControlName="produto_desc" readonly /></td>
              <td><input type="number" step="0.0001" formControlName="Qtp_pc" (input)="recalcEdit(i)" /></td>
              <td><input type="number" step="0.01" formControlName="valorunitario" (input)="recalcEdit(i)" /></td>
              <td><input type="number" step="0.01" formControlName="Desconto" (input)="recalcEdit(i)" /></td>
              <td><input type="number" formControlName="Total_item" readonly /></td>
            </tr>
          </tbody>
        </table>
      </div>
    </form>

    <div class="actions" style="margin-top:10px;">
      <button class="btn btn-primary" (click)="salvarEdicao()">Salvar alterações</button>
      <button class="btn" (click)="cancelarEdicao()">Cancelar</button>
    </div>
  </section>
</div>
