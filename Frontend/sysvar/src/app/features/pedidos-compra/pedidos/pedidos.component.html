<div class="pc-page">
  <div class="page-header">
    <h2>Pedidos de Compra</h2>
    <div class="actions-right">
      <button class="btn btn-light" (click)="setAction('novo')">Novo</button>
      <button class="btn btn-light" (click)="setAction('consultar')">Consultar</button>
    </div>
  </div>

  <div *ngIf="errorMsg" class="alert error">{{ errorMsg }}</div>
  <div *ngIf="fieldErrors.length" class="alert error">
    <div *ngFor="let fe of fieldErrors">
      <strong>{{ fe.field }}:</strong> {{ fe.messages.join('; ') }}
    </div>
  </div>
  <div *ngIf="successMsg" class="alert success">{{ successMsg }}</div>
  <div *ngIf="infoMsg" class="alert info">{{ infoMsg }}</div>

  <!-- PLACEHOLDER -->
  <section class="card form-placeholder" *ngIf="action === ''">
    <div class="placeholder-inner">
      <p>Para cadastrar um <strong>Pedido de Compra</strong>, clique em <strong>Novo</strong>.</p>
      <p>Para consultar/filtrar, clique em <strong>Consultar</strong>.</p>
    </div>
  </section>

  <!-- NOVO -->
  <!-- (sem mudanças) -->
  <section class="card" *ngIf="action === 'novo'">
    <!-- ... conteúdo igual ao seu arquivo atual ... -->
  </section>

  <!-- CONSULTAR -->
  <section class="card" *ngIf="action === 'consultar'">
    <h3>Consultar</h3>

    <form [formGroup]="filtrosForm" (ngSubmit)="buscar()" class="filters-grid">
      <label>Status
        <select formControlName="status">
          <option value="">(todos)</option>
          <option value="AB">AB (Aberto)</option>
          <option value="AP">AP (Aprovado)</option>
          <option value="CA">CA (Cancelado)</option>
          <!-- ⬇️ novos status no filtro -->
          <option value="AT">AT (Atendido)</option>
          <option value="PA">PA (Parcial aberto)</option>
          <option value="PE">PE (Parcial encerrado)</option>
        </select>
      </label>
      <label>Fornecedor (ID)
        <input type="number" formControlName="fornecedor" />
      </label>
      <label>Fornecedor (contém)
        <input type="text" formControlName="q_fornecedor" />
      </label>
      <label>Loja (ID)
        <input type="number" formControlName="loja" />
      </label>
      <!-- documento removido anteriormente -->
      <label>Emissão de
        <input type="date" formControlName="emissao_de" />
      </label>
      <label>Emissão até
        <input type="date" formControlName="emissao_ate" />
      </label>
      <label>Entrega de
        <input type="date" formControlName="entrega_de" />
      </label>
      <label>Entrega até
        <input type="date" formControlName="entrega_ate" />
      </label>

      <div class="filters-actions">
        <button class="btn btn-primary" type="submit">Aplicar</button>
        <button class="btn" type="button" (click)="limparFiltros()">Limpar</button>
      </div>
    </form>

    <div class="state" *ngIf="carregando()">Carregando...</div>

    <div class="table-wrap" *ngIf="!carregando() && rows().length > 0">
      <table>
        <thead>
          <tr>
            <th (click)="setOrdenacao('Datapedido')">Data do Pedido</th>
            <th (click)="setOrdenacao('Dataentrega')">Data de Entrega</th>
            <th (click)="setOrdenacao('Idpedidocompra')">Nº</th>
            <th (click)="setOrdenacao('Idfornecedor__Nome_fornecedor')">Fornecedor</th>
            <th (click)="setOrdenacao('Status')">Status</th>
            <th (click)="setOrdenacao('Valorpedido')">Total</th>
            <th>Loja</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of rows()">
            <td>{{ p.Datapedido | date:'dd/MM/yyyy' }}</td>
            <td>{{ p.Dataentrega | date:'dd/MM/yyyy' }}</td>
            <td>{{ p.Idpedidocompra }}</td>
            <td>{{ p.fornecedor_nome }}</td>
            <td>{{ p.Status }}</td>
            <td>{{ p.Valorpedido | number:'1.2-2' }}</td>
            <td>{{ p.loja_nome }}</td>
            <td style="white-space:nowrap; display:flex; gap:6px; flex-wrap:wrap;">
              <!-- regras de ação mantidas: só AB edita/aprova; AB/AP cancelam -->
              <button class="btn btn-primary" *ngIf="p.Status === 'AB'" (click)="aprovarLinha(p)" title="Aprovar">Aprovar</button>
              <button class="btn" *ngIf="p.Status === 'AB'" (click)="editarLinha(p)" title="Editar">Editar</button>
              <button class="btn btn-danger" *ngIf="p.Status === 'AB' || p.Status === 'AP'" (click)="cancelarLinha(p)" title="Cancelar">Cancelar</button>
              <button class="btn btn-light" *ngIf="p.Status === 'CA'" (click)="reabrirLinha(p)" title="Reabrir">Reabrir</button>
              <span *ngIf="p.Status !== 'AB' && p.Status !== 'AP' && p.Status !== 'CA'" class="muted">—</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- EDITAR -->
  <!-- (sem mudanças) -->
  <section class="card" *ngIf="action === 'editar'">
    <!-- ... conteúdo igual ao seu arquivo atual ... -->
  </section>
</div>

